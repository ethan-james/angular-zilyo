"use strict";function MainCtrl(a,b,c,d,e,f){this.markers=[],this.map=c,this.zilyo=d,this.params={guests:1,numofbedrooms:0,provider:[],pricemin:0,pricemax:1e3,stimestamp:new Date,etimestamp:new Date((new Date).getTime()+864e5)},a.$watch(_.bind(function(){return this.params},this),_.bind(_.debounce(function(a){this.markerClusterer&&this.updateMarkers(this.delta())},500),this),!0),this.providers=["airbnb","alwaysonvacation","apartmentsapart","bedycasa","bookingpal","citiesreference","edomizil","geronimo","gloveler","holidayvelvet","homeaway","homestay","hostelworld","housetrip","interhome","nflats","roomorama","stopsleepgo","theotherhome","travelmob","vacationrentalpeople","vaycayhero","waytostay","webchalet","zaranga"],this.filters=f;var g={element:document.getElementById("map"),callbacks:{onBoundsChanged:_.debounce(this.refresh.bind(this),1e3)},controls:{TOP_LEFT:[document.getElementById("github-wrapper"),document.getElementById("pac-input")],TOP_RIGHT:[document.getElementById("filters")]}};c.makeSearchBox(document.getElementById("pac-input")),navigator.geolocation.getCurrentPosition(function(a){c.loadMap(angular.extend(g,{lat:a.coords.latitude,lng:a.coords.longitude}))},function(){c.loadMap(angular.extend(g,{lat:37.3175,lng:-122.0419}))}),this.callbacks={onCountResults:function(a){this.preloaded=!0,this.loading=a.result.totalResults},onFetch:function(c){this.addMarkers(_.map(c.result,function(c,d){var f,g=angular.extend(a.$new(),{listing:c}),h=b('<listing-info-window listing="listing"></listing-info-window>')(g),i=e.create(c);return i.addListener("click",_.bind(function(){f&&f.getMap()?f.close():(f||(f=new google.maps.InfoWindow({content:h[0]})),f.open(this.map.map,i))},this)),i},this)),this.markerClusterer||(this.markerClusterer=new MarkerClusterer(this.map.map,[],{})),this.updateMarkers(this.delta(!1)),this.loading=this.loading-c.result.length}}}angular.module("angularZilyoApp",["ngCookies","ngResource","ngSanitize","ui.router","ui.bootstrap","ngMaterial"]).config(["$stateProvider","$urlRouterProvider","$locationProvider",function(a,b,c){b.otherwise("/"),c.html5Mode(!0)}]),angular.module("angularZilyoApp").constant("RESULT_FILTERS",{guests:function(a,b){return a.guests>=b},numofbedrooms:function(a,b){return a.numofbedrooms>=b},pricemin:function(a,b){return a.nightly>=b},pricemax:function(a,b){return a.nightly<=b},provider:function(a,b){return b&&b.length?-1!==b.indexOf(a.provider):!0},availability:function(a,b){return _.some(a.availability,function(a){return a.start<=b.stimestamp.getTime()/1e3&&a.end>=b.etimestamp.getTime()/1e3})}}),angular.module("angularZilyoApp").filter("capitalize",function(){return function(a){return a[0].toLocaleUpperCase()+a.substr(1)}}),angular.module("angularZilyoApp").directive("listingInfoWindow",function(){return{templateUrl:"app/listing-info-window/listing-info-window.html",restrict:"E",scope:{listing:"="},link:function(a,b,c){a.amenities=_.map(a.listing.amenities,function(a){return a.text}).join(", ")}}}),MainCtrl.$inject=["$scope","$compile","googleMap","zilyo","Marker","RESULT_FILTERS"],MainCtrl.prototype.filterMarkers=function(a){return _.filter(this.markers,function(a){return _.reduce(this.params,function(b,c,d){return this.filters[d]?b&&this.filters[d](a,this.params[d]):"stimestamp"==d||"etimestamp"==d?b&&this.filters.availability(a,this.params):b},!0,this)},this)},MainCtrl.prototype.difference=function(a,b){return _.filter(a,function(a){return _.every(b,function(b){return b.id!==a.id})})},MainCtrl.prototype.addMarkers=function(a){this.markers=this.markers.concat(this.difference(a,this.markers))},MainCtrl.prototype.updateMarkers=function(a){this.markerClusterer.addMarkers(a.add),this.markerClusterer.removeMarkers(a.remove),this.showing=this.markerClusterer.getTotalMarkers()},MainCtrl.prototype.delta=function(a){var b=this.markerClusterer.getMarkers(),c=this.filterMarkers();return{add:this.difference(c,b),remove:a===!1?[]:this.difference(b,c)}},MainCtrl.prototype.refresh=function(){var a=this.map.getBounds();this.zilyo.refresh({nelatitude:a.O.j,nelongitude:a.j.O,swlatitude:a.O.O,swlongitude:a.j.j},this.callbacks,this)},MainCtrl.$inject=["$scope","$compile","googleMap","zilyo","Marker","RESULT_FILTERS"],angular.module("angularZilyoApp").controller("MainCtrl",MainCtrl),angular.module("angularZilyoApp").config(["$stateProvider",function(a){a.state("main",{url:"/",templateUrl:"app/main/main.html",controller:"MainCtrl",controllerAs:"main"})}]);var Map=function(){this.map=null,this.center=null,this.mapElement=null};Map.prototype.loadMap=function(a,b){this.params=a,this.map=new google.maps.Map(a.element,{center:{lat:a.lat,lng:a.lng},zoom:17}),google.maps.event.addListenerOnce(this.map,"idle",this.onMapLoaded.bind(this))},Map.prototype.onMapLoaded=function(){_.each(this.params.controls,function(a,b){_.each(a,function(a){this.map.controls[google.maps.ControlPosition[b]].push(a)},this)},this),this.map.addListener("bounds_changed",this.params.callbacks.onBoundsChanged),this.map.addListener("bounds_changed",_.bind(function(){this.searchBox.setBounds(this.map.getBounds())},this)),this.searchBox.addListener("places_changed",_.bind(function(){var a=this.searchBox.getPlaces(),b=new google.maps.LatLngBounds;0!=a.length&&(a.forEach(function(a){b.extend(a.geometry.location)}),this.map.fitBounds(b),this.map.setZoom(17))},this)),"function"==typeof this.params.callbacks.onBoundsChanged&&this.params.callbacks.onBoundsChanged()},Map.prototype.getBounds=function(){return this.map.getBounds()},Map.prototype.makeSearchBox=function(a){return this.searchBox=new google.maps.places.SearchBox(a),this.searchBox},angular.module("angularZilyoApp").service("googleMap",Map),angular.module("angularZilyoApp").factory("Marker",function(){return{create:function(a){return new google.maps.Marker({id:a.id,title:a.attr.heading,position:new google.maps.LatLng(a.latLng[0],a.latLng[1]),guests:a.attr.occupancy,numofbedrooms:a.attr.bedrooms,nightly:a.price.nightly,provider:a.provider.cid,availability:a.availability})}}}),angular.module("angularZilyoApp").directive("multipleSelect",function(){return{templateUrl:"app/multiple-select/multiple-select.html",restrict:"E",require:"ngModel",scope:{options:"="},link:function(a,b,c,d){a.$watch(function(){return d.$modelValue},function(b){a.select=a.options.reduce(function(a,c){return a[c]=-1!==b.indexOf(c),a},{})}),a.$watch("select",function(b){a.value=_.reduce(b,function(a,c,d){return b[d]?a.concat(d):a},[]),d.$setViewValue(a.value)},!0),a.toggle=function(b,c){b.stopPropagation(),a.select[c]=!a.select[c]}}}}),angular.module("angularZilyoApp").filter("parameterize",function(){return function(a){return _.reduce(a,function(a,b,c){return b?a.concat(c+"="+b):a},[]).join("&")}}),angular.module("angularZilyoApp").service("zilyo",["$http","$filter",function(a,b){var c=function(c,d,e,f){a.get(c+"?"+b("parameterize")(d)).then(function(a){e&&"function"==typeof e.onFetch&&e.onFetch.call(f,JSON.parse(a.data))},function(a){console.log(a)})},d=function(){this.baseUrl="/api/v1/listings",this.countUrl="/api/v1/listings/count"};return d.prototype.refresh=function(d,e,f){var g=this.baseUrl;a.get(this.countUrl+"?"+b("parameterize")(d)).then(function(a){var b=JSON.parse(a.data);e&&"function"==typeof e.onCountResults&&e.onCountResults.call(f,b),_.times(b.result.totalPages,function(a){return c(g,angular.extend(d,{resultsperpage:20,page:a+1}),e,f)})},function(a){console.log(a)})},new d}]),angular.module("angularZilyoApp").factory("Modal",["$rootScope","$modal",function(a,b){function c(c,d){var e=a.$new();return c=c||{},d=d||"modal-default",angular.extend(e,c),b.open({templateUrl:"components/modal/modal.html",windowClass:d,scope:e})}return{confirm:{"delete":function(a){return a=a||angular.noop,function(){var b,d=Array.prototype.slice.call(arguments),e=d.shift();b=c({modal:{dismissable:!0,title:"Confirm Delete",html:"<p>Are you sure you want to delete <strong>"+e+"</strong> ?</p>",buttons:[{classes:"btn-danger",text:"Delete",click:function(a){b.close(a)}},{classes:"btn-default",text:"Cancel",click:function(a){b.dismiss(a)}}]}},"modal-danger"),b.result.then(function(b){a.apply(b,d)})}}}}}]),angular.module("angularZilyoApp").controller("NavbarCtrl",["$scope","$location",function(a,b){a.menu=[{title:"Home",link:"/"}],a.isCollapsed=!0,a.isActive=function(a){return a===b.path()}}]),angular.module("angularZilyoApp").run(["$templateCache",function(a){a.put("app/listing-info-window/listing-info-window.html","<div class=listing-info-window><div>{{listing.attr.heading}} <b>${{listing.price.nightly}}</b> / night</div><div><img src={{listing.photos[0].small}} alt={{listing.photos[0].caption}}></div><div><b>Occupancy</b> {{listing.attr.occupancy}} guests, <b>Bedrooms</b> {{listing.attr.bedrooms}}, <b>Bathrooms</b> {{listing.attr.bathrooms}}</div><div><b>Amenities</b> {{amenities}}</div><div><a href={{listing.provider.url}} target=_blank>View Listing</a></div></div>"),a.put("app/main/main.html",'<div class=col-md-12><input id=pac-input class=form-control><div id=filters><div id=handle class=clearfix><i class="fa fa-circle-o-notch pull-left spinner" id=spinner ng-show=main.loading></i> <span id=status><span id=showing ng-show="main.showing != main.markers.length">Showing <b>{{main.showing}}</b> of</span> <b>{{markers.length}}</b> listings <span id=queue ng-show=main.loading>(loading <b>{{main.loading}}</b>)</span></span> <button aria-expanded=false class="btn btn-primary pull-right" ng-show=!expanded ng-click="expanded = true"><i class="fa fa-caret-left"></i></button> <button aria-expanded=false class="btn btn-primary pull-right" ng-show=expanded ng-click="expanded = false"><i class="fa fa-caret-down"></i></button></div><div ng-show=expanded id=panel><div class="input-group col-md-12"><label for=guests class="col-md-9 control-label">Minimum guests allowed</label><span class=col-md-3><input type=number id=bedrooms ng-model=main.params.guests class=form-control></span></div><div class="input-group col-md-12"><label for=bedrooms class="col-md-9 control-label">Minimum number of bedrooms</label><span class=col-md-3><input type=number id=bedrooms ng-model=main.params.numofbedrooms class=form-control></span></div><div class="input-group col-md-12"><label for=pricemax class="col-md-6 control-label">Provider</label><span class=col-md-6><multiple-select ng-model=main.params.provider options=main.providers></multiple-select></span></div><div class="input-group col-md-12"><label for=pricemax class="col-md-6 control-label">Maximum price per night: <b>${{main.params.pricemax}}</b></label><span class=col-md-6><input type=range id=pricemax ng-model=main.params.pricemax min=0 max=1000 step=5></span></div><div class="input-group col-md-12"><label for=pricemin class="col-md-6 control-label">Minimum price per night: <b>${{main.params.pricemin}}</b></label><span class=col-md-6><input type=range id=pricemin ng-model=main.params.pricemin min=0 max=1000 step=5></span></div><div class="input-group col-md-12"><div class=col-md-6><md-datepicker ng-model=main.params.stimestamp md-placeholder="Check in date"></md-datepicker></div><div class=col-md-6><md-datepicker ng-model=main.params.etimestamp md-placeholder="Check out date"></md-datepicker></div></div></div></div><div id=github-wrapper><a class="btn btn-success" href=//github.com/ethan-james/angular-zilyo id=github target=_blank><i class="fa fa-github"></i></a></div><div id=map></div></div><div id=overlay ng-show=!main.preloaded><div class=spinner><i class="fa fa-circle-o-notch"></i></div></div>'),a.put("app/multiple-select/multiple-select.html",'<div class="form-inline multiple-select"><div class="form-group dropdown"><div class=input-group><input ng-model=value class=form-control> <span class=input-group-addon><button data-toggle=dropdown aria-haspopup=true aria-expanded=false class=dropdown-toggle><i class="fa fa-caret-down"></i></button></span></div><ul class=dropdown-menu><li ng-repeat="option in options" class=col-md-12 ng-click="toggle($event, option)"><i class="fa fa-square-o" ng-show=!select[option]></i> <i class="fa fa-check-square-o" ng-show=select[option]></i> {{option | capitalize}}</li></ul></div></div><!-- funsportsgear.com -->'),a.put("components/modal/modal.html",'<div class=modal-header><button ng-if=modal.dismissable type=button ng-click=$dismiss() class=close>&times;</button><h4 ng-if=modal.title ng-bind=modal.title class=modal-title></h4></div><div class=modal-body><p ng-if=modal.text ng-bind=modal.text></p><div ng-if=modal.html ng-bind-html=modal.html></div></div><div class=modal-footer><button ng-repeat="button in modal.buttons" ng-class=button.classes ng-click=button.click($event) ng-bind=button.text class=btn></button></div>'),a.put("components/navbar/navbar.html",'<div class="navbar navbar-default navbar-static-top" ng-controller=NavbarCtrl><div class=container><div class=navbar-header><button class=navbar-toggle type=button ng-click="isCollapsed = !isCollapsed"><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a href="/" class=navbar-brand>angular-zilyo</a></div><div collapse=isCollapsed class="navbar-collapse collapse" id=navbar-main><ul class="nav navbar-nav"><li ng-repeat="item in menu" ng-class="{active: isActive(item.link)}"><a ng-href={{item.link}}>{{item.title}}</a></li></ul></div></div></div>')}]);